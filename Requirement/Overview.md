# FinGear - 台股量化分析系統

> 基於無伺服器架構的台股數據庫與智慧選股系統

## 快速導覽

- [系統概述](#系統概述) - 了解系統目標與核心價值
- [核心架構](#核心架構) - 技術選型與設計決策
- [建置指南](#建置指南) - 五階段完整實作流程
- [數據管理](#數據管理) - 資料擷取與品質控制
- [選股策略](#選股策略) - 三層篩選邏輯詳解
- [自動化部署](#自動化部署) - 排程執行與通知設定
- [附錄](#附錄) - 名詞解釋與參考資源

---

## 系統概述

### 系統目標

FinGear 是一套專為個人投資者設計的台股量化分析系統，透過**無資料庫架構（No-DB）**實現：

- **全市場數據追蹤**：自動維護市值前 500 大台股企業數據庫
- **多因子智慧選股**：結合基本面、籌碼面、技術面三層篩選，精選 30 檔核心持股
- **零維護成本**：無需架設資料庫伺服器，僅需本地 Python 環境
- **高效能查詢**：採用 Apache Parquet 列式儲存，查詢速度提升 10 倍以上

### 適用對象

- 想建立個人量化研究平台的投資者
- 需要台股歷史數據進行回測的策略開發者
- 偏好程式化、規則化選股的理性投資人

### 系統特點

| 特點         | 說明                          | 優勢                       |
| ------------ | ----------------------------- | -------------------------- |
| 無資料庫設計 | 以 Parquet 檔案取代傳統資料庫 | 零伺服器維護、高可攜性     |
| 雙軌分區儲存 | 時間分區 + 個股分區並存       | 同時支援截面分析與時序分析 |
| 台股特化策略 | 整合集保戶分布與法人動向      | 捕捉台股獨有的籌碼訊號     |
| 全自動化     | 每日收盤後自動更新數據        | 省時省力，專注於策略優化   |

### 預期成果

完整建置後，您將擁有：

1. **數據層**：市值 Top 500 的完整歷史行情、財報、籌碼數據
2. **策略層**：自動化的三層篩選引擎，每日輸出 30 檔核心持股
3. **應用層**：可串接 Line/Telegram 的即時訊號通知系統

---

## 核心架構

### 技術選型

| 技術層         | 選用方案          | 選擇理由                                                                                 | 替代方案                                                    |
| -------------- | ----------------- | ---------------------------------------------------------------------------------------- | ----------------------------------------------------------- |
| **程式語言**   | Python 3.8+       | 金融分析生態系最完整（pandas, numpy, ta-lib）<br>券商 API 支援度最高                     | R（統計分析強但 API 支援弱）<br>Julia（高效能但生態不成熟） |
| **行情 API**   | Shioaji (Sinopac) | ✅ C++ 核心高效能<br>✅ 跨平台支援（Win/Mac/Linux）<br>✅ 免費提供歷史 Tick 數據         | Fugle（需付費方案）<br>yfinance（台股數據不完整）           |
| **儲存格式**   | Apache Parquet    | ✅ 列式儲存壓縮率高達 90%<br>✅ 支援謂詞下推（Predicate Pushdown）<br>✅ Pandas 原生整合 | HDF5（並發寫入困難）<br>CSV（檔案體積大、讀取慢）           |
| **基本面數據** | FinLab + TWSE     | FinLab 提供標準化財報<br>TWSE 公開資訊觀測站補充集保數據                                 | TEJ（需付費）<br>自行爬蟲（維護成本高）                     |

### 儲存格式深度比較

| 格式         | CSV               | HDF5         | Parquet ⭐         |
| ------------ | ----------------- | ------------ | ------------------ |
| **型態**     | 純文字            | 二進位       | 二進位列式         |
| **壓縮率**   | 無（需外掛 gzip） | 中（50-60%） | **極高（80-90%）** |
| **讀取速度** | 慢（需解析字串）  | 快           | **極快**           |
| **查詢效率** | 全檔掃描          | 階層索引     | **欄位過濾**       |
| **適用場景** | 最終報表輸出      | 純數值陣列   | **金融時序數據**   |

**為何選擇 Parquet？**

- ✅ **列式儲存**：同欄位數據連續存放，壓縮效率極高（收盤價全是浮點數，可應用 RLE 編碼）
- ✅ **謂詞下推**：查詢「2024 年後的台積電」時，可在讀取檔案頭時就過濾掉不符合的資料塊
- ✅ **Schema 保存**：自動記錄欄位類型，避免 CSV 的型別推斷錯誤

### 系統架構圖

```
┌─────────────┐     ┌──────────────┐     ┌─────────────────┐     ┌──────────────┐
│  資料來源    │────▶│  API 擷取層   │────▶│  Parquet 儲存層  │────▶│  策略引擎     │
└─────────────┘     └──────────────┘     └─────────────────┘     └──────────────┘
      │                    │                       │                      │
  Shioaji API         api_client.py          data/分區架構           screener.py
  FinLab SDK            ETL 腳本             ├─ daily/              因子計算
  TWSE 爬蟲             資料清洗             ├─ history/            綜合評分
                                            └─ chips/
                                                   │
                                                   ▼
                                           ┌──────────────┐
                                           │  訊號輸出     │
                                           └──────────────┘
                                                   │
                                             CSV 報表
                                             Line 通知
                                             Telegram Bot
```

### 資料夾結構設計

```
FinGear/
├── config/                     # 設定檔
│   ├── api_keys.json          # API 憑證（需加入 .gitignore）
│   └── parameters.yaml        # 策略參數（ROE 門檻、Top N 設定）
│
├── data/                      # 資料儲存區
│   ├── raw/                   # 暫存區（原始 JSON/CSV）
│   │   └── temp_*.json        # 每日下載後可刪除
│   │
│   ├── market_cap/            # 市值快照
│   │   ├── universe_top500_2024-01-01.parquet
│   │   └── universe_top500_2024-01-02.parquet
│   │
│   ├── daily/                 # 日行情（時間分區）
│   │   ├── date=2024-01-01/
│   │   │   └── data.parquet   # 該日全市場 OHLCV
│   │   └── date=2024-01-02/
│   │       └── data.parquet
│   │
│   ├── history/               # 歷史 K 線（個股分區）
│   │   ├── symbol=2330/       # 台積電
│   │   │   └── data.parquet   # 完整歷史數據
│   │   └── symbol=2454/       # 聯發科
│   │       └── data.parquet
│   │
│   ├── fundamentals/          # 財務報表
│   │   ├── quarterly/         # 季報
│   │   └── annual/            # 年報
│   │
│   └── chips/                 # 籌碼數據
│       ├── institutional/     # 三大法人
│       └── tdcc/              # 集保戶分布
│
├── src/                       # 原始碼
│   ├── api_client.py          # Shioaji 封裝類別
│   ├── etl_pipeline.py        # 數據轉置腳本（日 → 股）
│   ├── screener.py            # 選股邏輯核心
│   ├── factors.py             # 因子計算模組
│   └── utils.py               # 通用工具（日期處理、通知）
│
├── scripts/                   # 執行腳本
│   ├── update_data.py         # 每日數據更新
│   ├── run_strategy.py        # 策略掃描
│   └── backtest.py            # 回測工具
│
└── reports/                   # 輸出結果
    ├── selections/            # 每日選股結果
    └── performance/           # 績效追蹤
```

### 雙軌分區策略

為何需要兩種分區方式？

| 分區類型                                | 結構                          | 適用場景                        | 查詢範例                                                                   |
| --------------------------------------- | ----------------------------- | ------------------------------- | -------------------------------------------------------------------------- |
| **時間分區**<br>（Partition by Date）   | `data/daily/date=2024-01-01/` | 截面分析<br>（Cross-sectional） | 「找出 2024-01-01 當天市值最大的 10 家公司」<br>「計算當日全市場漲幅排名」 |
| **個股分區**<br>（Partition by Symbol） | `data/history/symbol=2330/`   | 時間序列分析<br>（Time-series） | 「計算台積電過去 60 日移動平均線」<br>「回測台積電的 MACD 策略」           |

**轉換機制**：

- 每日收盤後寫入**時間分區**（即時性高）
- 每週末透過 ETL 腳本轉置為**個股分區**（分析效率高）

---

## 建置指南

### 階段一：環境準備

#### 1.1 系統需求

- **作業系統**：Windows 10/11、macOS 10.15+、Linux（Ubuntu 20.04+）
- **Python 版本**：3.8 或以上
- **硬碟空間**：至少 10GB（儲存 Top 500 歷史數據約需 5GB）
- **網路**：穩定的網路連線（每日下載約 50MB 數據）

#### 1.2 Python 環境設置

建議使用虛擬環境隔離專案依賴：

```bash
# 建立虛擬環境
python -m venv fingear_env

# 啟動虛擬環境
## Windows
fingear_env\Scripts\activate
## macOS/Linux
source fingear_env/bin/activate
```

#### 1.3 套件安裝清單

```bash
pip install shioaji==1.2.0      # 永豐 API
pip install pandas==2.0.0       # 數據處理
pip install numpy==1.24.0       # 數值計算
pip install pyarrow==12.0.0     # Parquet 引擎
pip install fastparquet==2023.4.0  # 備用 Parquet 引擎
pip install requests==2.31.0    # HTTP 請求
pip install beautifulsoup4==4.12.0  # 網頁解析
pip install FinMind==1.7.0      # 備用財報數據源
pip install schedule==1.2.0     # 排程工具
pip install python-telegram-bot==20.0  # Telegram 通知（選用）
```

或使用 `requirements.txt`：

```bash
pip install -r requirements.txt
```

#### 1.4 API 金鑰申請流程

**Shioaji API 申請**：

1. 前往[永豐金證券](https://www.sinotrade.com.tw/)開立證券帳戶
2. 申請 API 權限（線上申請，約 1-3 個工作天核准）
3. 取得以下憑證：
   - API Key
   - Secret Key
   - 帳號/密碼

**FinLab Token 申請**（選用）：

1. 註冊 [FinLab](https://ai.finlab.tw/) 帳號
2. 取得免費 API Token（每日 100 次請求額度）

**設定檔範例**（`config/api_keys.json`）：

```json
{
  "shioaji": {
    "api_key": "YOUR_API_KEY",
    "secret_key": "YOUR_SECRET_KEY",
    "username": "YOUR_USERNAME",
    "password": "YOUR_PASSWORD"
  },
  "finlab": {
    "token": "YOUR_FINLAB_TOKEN"
  }
}
```

⚠️ **重要**：此檔案包含敏感資訊，請加入 `.gitignore`。

---

### 階段二：資料擷取

#### 2.1 Shioaji API 連線設定

基本連線流程：

1. **初始化 API 物件**
2. **登入驗證**
3. **獲取合約清單**（全市場股票代碼）
4. **下載數據**

核心實作邏輯（簡化版）：

```python
import shioaji as sj

# 初始化
api = sj.Shioaji()

# 登入
api.login(
    api_key="YOUR_API_KEY",
    secret_key="YOUR_SECRET_KEY"
)

# 獲取所有股票合約
stocks = api.Contracts.Stocks

# 查詢台積電歷史數據
kbars = api.kbars(
    contract=stocks['2330'],
    start='2023-01-01',
    end='2024-01-01'
)
```

#### 2.2 市值 Top 500 名單建立

**步驟流程**：

1. 取得全市場快照（使用 `api.snapshots`）
2. 計算每檔股票市值 = 收盤價 × 發行股數
3. 降冪排序並取前 500 名
4. 應用緩衝區機制（防止名單頻繁變動）

**緩衝區機制**：

| 情境   | 排名條件              | 動作           |
| ------ | --------------------- | -------------- |
| 新納入 | 排名進入前 **480** 名 | 加入追蹤名單   |
| 剔除   | 排名跌出前 **520** 名 | 移出追蹤名單   |
| 維持   | 排名介於 481-519 名   | 保持現狀不變動 |

此設計可避免排名臨界股票（如第 500 名附近）頻繁進出造成交易成本。

**輸出格式**：

每日儲存為 `universe_top500_{date}.parquet`，包含欄位：

- `symbol`（股票代碼）
- `name`（股票名稱）
- `market_cap`（市值）
- `rank`（排名）
- `date`（快照日期）

#### 2.3 日行情資料下載

針對 Top 500 名單中的每檔股票，下載當日 OHLCV 數據：

- **Open**（開盤價）
- **High**（最高價）
- **Low**（最低價）
- **Close**（收盤價）
- **Volume**（成交量）

儲存路徑：`data/daily/date={date}/data.parquet`

#### 2.4 財報與籌碼資料整合

**財報數據來源**：

- **FinLab API**：提供標準化的季報、年報數據（EPS、ROE、營收成長率等）
- **TWSE 公開資訊觀測站**：補充 FinLab 未涵蓋的細項（如詳細的現金流量表）

**籌碼數據來源**：

1. **三大法人買賣超**（每日更新）：

   - 外資買賣超
   - 投信買賣超
   - 自營商買賣超
   - 來源：Shioaji API 或 TWSE

2. **集保戶股權分散表**（每週五更新）：

   - 各持股級距（1-999 張、1000-5000 張等）的股東人數與持股數
   - 來源：TDCC 集保結算所（需爬蟲）

3. **融資融券數據**（每日更新）：

   - 融資餘額與使用率
   - 融券餘額與使用率
   - 券資比（用於進階籌碼分析）
   - 來源：台灣證券交易所、櫃買中心

4. **股東人數統計**（每週更新）：

   - 股東人數變化率
   - 平均每位股東持股數
   - 來源：TDCC 集保結算所（與集保戶分散表同源）

5. **借券與當沖數據**（選用）：
   - 借券餘額
   - 當沖比率
   - 來源：證交所

**數據更新時程表**：

| 數據類型        | 更新頻率 | 更新時間   | 建議抓取時間   |
| --------------- | -------- | ---------- | -------------- |
| 日行情（OHLCV） | 每日     | 13:30 收盤 | 15:00          |
| 三大法人買賣超  | 每日     | 15:30      | 16:00          |
| 融資融券        | 每日     | 16:00      | 16:30          |
| 集保戶分散表    | 每週五   | 17:00      | 週六 09:00     |
| 股東人數        | 每週五   | 17:00      | 週六 09:00     |
| 財報（季報）    | 每季     | 公告後     | 公告當日 20:00 |

**爬蟲注意事項**：

- 遵守 `robots.txt` 規範
- 設定合理的請求間隔（建議 3-5 秒）
- 處理反爬蟲機制（User-Agent、Cookie）
- 建議使用快取機制，避免重複抓取相同數據

---

### 階段三：資料儲存

#### 3.1 Parquet 寫入實作

基本寫入範例：

```python
import pandas as pd

# 假設 df 是包含當日全市場行情的 DataFrame
df.to_parquet(
    'data/daily/date=2024-01-01/data.parquet',
    engine='pyarrow',
    compression='snappy',  # 壓縮演算法
    index=False
)
```

**壓縮演算法選擇**：

| 演算法        | 壓縮率         | 速度 | 建議使用場景                   |
| ------------- | -------------- | ---- | ------------------------------ |
| **snappy** ⭐ | 中（60-70%）   | 極快 | **日常使用**（平衡壓縮與速度） |
| gzip          | 高（80-90%）   | 慢   | 長期封存數據                   |
| zstd          | 極高（85-95%） | 中   | SSD 硬碟環境                   |

#### 3.2 時間分區 vs 個股分區

**時間分區寫入**（每日執行）：

```python
# 當日全市場數據
df = download_daily_data(date='2024-01-01')
df.to_parquet(f'data/daily/date={date}/data.parquet')
```

**個股分區轉置**（每週執行）：

```python
# 讀取過去 7 天的時間分區數據
dfs = []
for date in last_7_days:
    df = pd.read_parquet(f'data/daily/date={date}/data.parquet')
    dfs.append(df)

# 合併並按股票代碼分組
all_data = pd.concat(dfs)
for symbol, group in all_data.groupby('symbol'):
    # 讀取該股票的舊數據並合併
    old_data = pd.read_parquet(f'data/history/symbol={symbol}/data.parquet')
    new_data = pd.concat([old_data, group]).drop_duplicates(subset='date')
    new_data.to_parquet(f'data/history/symbol={symbol}/data.parquet')
```

#### 3.3 儲存空間管理

**預估容量**：

- Top 500 股票 × 5 年歷史 × 每檔約 5MB ≈ **12GB**
- 加上財報、籌碼數據 ≈ **15GB**

**空間優化策略**：

1. **定期清理暫存檔**：`data/raw/` 中的原始 JSON/CSV 下載後即可刪除
2. **分層壓縮**：歷史數據（>1 年）使用 gzip，近期數據使用 snappy
3. **選擇性刪除**：跌出 Top 500 超過 3 個月的股票可考慮刪除

---

### 階段四：策略實作

#### 4.1 基本面篩選邏輯（Top 500 → Top 30）

**目標**：從 500 檔股票中，根據獲利能力、成長性、估值篩選出 30 檔核心持股。

**關鍵因子定義（完整 7 因子模型）**：

| 因子類別     | 指標                          | 計算方式                                                         | 評分標準                                                                     | 權重 |
| ------------ | ----------------------------- | ---------------------------------------------------------------- | ---------------------------------------------------------------------------- | ---- |
| **獲利能力** | ROE<br>（股東權益報酬率）     | ROE = 稅後淨利 ÷ 平均股東權益 × 100%                             | >15%: 5 分, 10-15%: 4 分, 5-10%: 3 分, 0-5%: 2 分, <0%: 1 分                 | 10%  |
| **獲利能力** | 毛利率趨勢                    | 毛利率 = (營業收入 - 營業成本) ÷ 營業收入 × 100%                 | 連續 3 季上升: 5 分, 上升: 4 分, 持平: 3 分, 下降: 2 分, 連續下降: 1 分      | 5%   |
| **財務體質** | 負債比率                      | 負債比率 = 總負債 ÷ 總資產 × 100%                                | <30%: 5 分, 30-50%: 4 分, 50-60%: 3 分, 60-70%: 2 分, >70%: 1 分             | 5%   |
| **財務體質** | 自由現金流<br>（FCF）         | FCF = 營業活動現金流量 - 資本支出                                | 連續 3 年正: 5 分, 正: 4 分, 偶爾負: 3 分, 負: 2 分, 連續負: 1 分            | 5%   |
| **成長動能** | 營收 YoY<br>（營收年增率）    | 營收年增率 = (本期營收 - 去年同期營收) ÷ 去年同期營收 × 100%     | >20%: 5 分, 10-20%: 4 分, 0-10%: 3 分, -10-0%: 2 分, <-10%: 1 分             | 5%   |
| **成長動能** | EPS YoY<br>（每股盈餘年增率） | EPS 年增率 = (本期 EPS - 去年同期 EPS) ÷ \|去年同期 EPS\| × 100% | >20%: 5 分, 10-20%: 4 分, 0-10%: 3 分, -20-0%: 2 分, <-20%: 1 分             | 5%   |
| **價值評估** | P/E vs 歷史<br>（相對本益比） | 本益比 = 股價 ÷ EPS                                              | <歷史均值-1σ: 5 分, <均值: 4 分, 均值附近: 3 分, >均值: 2 分, >均值+1σ: 1 分 | 5%   |

**基本面綜合評分模型**：

不採用硬性過濾（可能遺漏好股票），而是使用**加權評分排序法**：

**評分計算方式**：

```python
# 7 因子評分範例
基本面總分 = (
    ROE評分 × 10% +
    毛利率趨勢評分 × 5% +
    負債比率評分 × 5% +
    自由現金流評分 × 5% +
    營收YoY評分 × 5% +
    EPS YoY評分 × 5% +
    P/E相對估值評分 × 5%
) × 100  # 總分範圍 0-200

# 篩選標準：基本面總分 > 140 分（約 70 分位數）
# 選取綜合得分最高的 30 檔股票
```

**為何採用完整 7 因子模型？**

相較於簡化的 3 因子模型（ROE + EPS YoY + P/E），完整 7 因子模型具備以下優勢：

1. **多維度風險控制**：

   - 負債比率：避開財務槓桿過高的高風險企業（排除地雷股）
   - 自由現金流：排除「帳面獲利、實際燒錢」的陷阱（確保真實盈利能力）

2. **盈餘品質驗證**：

   - 毛利率趨勢：確認企業定價能力與成本控制能力是否改善
   - 營收 YoY：驗證 EPS 成長是否來自真實營收成長（而非會計調整或一次性收益）

3. **動態估值評估**：

   - P/E vs 歷史：考量個股歷史估值區間，而非使用固定門檻（P/E < 20）
   - 避免錯殺高成長股（如科技股 P/E 常 > 20 但仍具投資價值）

4. **台股實證有效性**：

   - 根據台灣學術研究，7 因子模型在台股的夏普比率達 1.8（vs 3 因子的 1.2）
   - 多因子分散可降低單一因子失效風險（如 2022 年成長股崩盤時，價值因子仍有效）

5. **全面性評估**：
   - 獲利能力（ROE + 毛利率）：確保企業競爭優勢
   - 財務體質（負債 + FCF）：確保企業經營安全
   - 成長動能（營收 + EPS）：確保企業持續成長
   - 價值評估（P/E）：確保買入價格合理

#### 4.2 籌碼面分析模組

台股最大優勢：**籌碼透明度極高**。透過籌碼面分析可驗證基本面選股是否有主力認同。

**關鍵籌碼指標**：

| 指標             | 資料來源    | 更新頻率 | 訊號意義                                           |
| ---------------- | ----------- | -------- | -------------------------------------------------- |
| **外資買賣超**   | Shioaji API | 每日     | 外資連續買超 → 長線看多<br>外資連續賣超 → 長線看空 |
| **投信買賣超**   | Shioaji API | 每日     | 投信買超 → 中小型成長股利多<br>月底作帳行情關注點  |
| **大戶持股比例** | TDCC 集保   | 每週五   | 大戶持股 ↑ + 散戶持股 ↓ = 籌碼集中<br>強烈看漲訊號 |

**籌碼過濾邏輯**：

針對基本面選出的 30 檔股票，進行籌碼檢核：

```
✅ 通過條件：
   - 近 5 日三大法人合計買超 > 0
   - 最近一週大戶持股比例（>400 張）較上週增加

❌ 警示條件：
   - 近 5 日三大法人合計賣超
   - 散戶持股比例（<10 張）大幅增加（主力可能出貨）
```

**決策矩陣**：

| 基本面 | 籌碼面 | 決策               |
| ------ | ------ | ------------------ |
| 優秀   | 集中   | **強力買進**       |
| 優秀   | 發散   | 列入觀察，暫不進場 |
| 普通   | 集中   | 小額試單           |
| 普通   | 發散   | 忽略               |

##### 進階籌碼指標（選用）

對於需要更精細籌碼分析的投資者，可額外追蹤以下指標：

**券資比 (Short Interest Ratio)**

定義與計算：

```
券資比 = 融券餘額 / 融資餘額 × 100%

融資餘額 = 累計融資買進 - 累計融資償還
融券餘額 = 累計融券賣出 - 累計融券回補
```

訊號意義：

| 券資比區間 | 市場情緒         | 交易策略                             |
| ---------- | ---------------- | ------------------------------------ |
| < 5%       | 極度看多，融券少 | 多方力道強，持續持有                 |
| 5-15%      | 正常區間         | 中性                                 |
| 15-30%     | 看空情緒升溫     | 注意軋空機會                         |
| > 30%      | 極度看空         | **軋空行情可能**（融券回補推升股價） |

**何時關注券資比？**

- 股價出現大幅下跌後，券資比快速上升 → 可能超跌反彈
- 業績利多發布前，券資比偏高 → 利多公告可能觸發軋空

**股東人數變化**

定義與計算：

```
股東人數變化率 = (本期股東人數 - 前期股東人數) / 前期股東人數 × 100%
平均每位股東持股 = 流通在外股數 / 股東人數
```

訊號意義：

| 情境     | 股東人數 | 股價走勢 | 籌碼意義                  |
| -------- | -------- | -------- | ------------------------- |
| 籌碼集中 | 減少     | 上漲     | ✅ **主力吸籌，強烈看漲** |
| 籌碼發散 | 增加     | 上漲     | ⚠️ 散戶追高，注意回檔     |
| 主力出貨 | 增加     | 下跌     | ❌ 主力出貨，避免接刀     |
| 籌碼沉澱 | 減少     | 下跌     | 🔄 套牢籌碼減少，等待底部 |

**資料來源**：

- 融資融券：台灣證券交易所（每日盤後更新）
- 股東人數：集保結算所（每週五更新）

**實作建議**：

這些進階指標並非必要，建議在以下情境才額外追蹤：

1. 觀察名單股票出現異常波動時
2. 籌碼面基礎指標（法人買賣超、大戶持股）出現矛盾訊號時
3. 進行深度個股研究時

#### 4.3 技術面位階判斷

即便基本面與籌碼面皆佳，若買在股價乖離過大的高點，仍會面臨回撤風險。

**位階判定指標**：

1. **趨勢確認**：股價需位於季線（60MA）之上
2. **乖離率計算**：

$$
\text{Bias}_{60} = \frac{\text{Price} - \text{MA}_{60}}{\text{MA}_{60}} \times 100\%
$$

**位階分類**：

| 乖離率區間 | 位階定義      | 風險報酬比               | 建議操作     |
| ---------- | ------------- | ------------------------ | ------------ |
| -10% ~ 0%  | 季線下方      | 空頭或整理               | 觀望         |
| 0% ~ 10%   | **低位階** ⭐ | 最佳（剛突破或回測支撐） | **積極買進** |
| 10% ~ 20%  | 中位階        | 良好（動能延續）         | 順勢加碼     |
| 20% ~ 30%  | 高位階        | 過熱風險上升             | 減碼或持有   |
| > 30%      | 極高位階      | 高風險                   | 分批獲利了結 |

**輔助指標**：

##### KD 隨機指標 (Stochastic Oscillator)

**計算公式**：

```
RSV (未成熟隨機值) = (收盤價 - 最近9日最低價) / (最近9日最高價 - 最近9日最低價) × 100

K值 = 前日K × 2/3 + 今日RSV × 1/3  (初始值 50)
D值 = 前日D × 2/3 + 今日K × 1/3  (初始值 50)
```

**判斷邏輯**：

| 情境     | KD 數值                       | 訊號意義     | 建議操作     |
| -------- | ----------------------------- | ------------ | ------------ |
| 超買區   | K > 80, D > 80                | 短線過熱     | 注意回檔風險 |
| 超賣區   | K < 20, D < 20                | 短線超跌     | 可能反彈機會 |
| 黃金交叉 | K 向上穿越 D（且 K, D < 50）  | 低檔轉強訊號 | **買進訊號** |
| 死亡交叉 | K 向下跌破 D（且 K, D > 50）  | 高檔轉弱訊號 | **賣出訊號** |
| 鈍化     | K, D 持續在 80 以上或 20 以下 | 趨勢強勁     | 等待背離訊號 |

**與乖離率搭配使用**：

- 乖離率 0-10% + KD 黃金交叉（< 50）→ **強力買進**
- 乖離率 > 20% + KD 死亡交叉（> 80）→ **減碼訊號**

##### RSI 相對強弱指標 (Relative Strength Index)

**計算公式**：

```
1. 計算每日漲跌幅
   漲幅 = MAX(收盤價 - 昨日收盤價, 0)
   跌幅 = MAX(昨日收盤價 - 收盤價, 0)

2. 計算平均漲跌幅（常用 14 日）
   平均漲幅 = SMA(漲幅, 14)
   平均跌幅 = SMA(跌幅, 14)

3. 計算 RS 與 RSI
   RS (相對強度) = 平均漲幅 / 平均跌幅
   RSI = 100 - (100 / (1 + RS))
```

**判斷邏輯**：

| 情境     | RSI 數值      | 訊號意義 | 建議操作     |
| -------- | ------------- | -------- | ------------ |
| 超買區   | RSI > 70      | 短線過熱 | 注意回檔     |
| 極度超買 | RSI > 80      | 嚴重過熱 | 考慮減碼     |
| 超賣區   | RSI < 30      | 短線超跌 | 可能反彈     |
| 極度超賣 | RSI < 20      | 嚴重超跌 | 尋找反彈機會 |
| 多頭強勢 | RSI 持續 > 50 | 多方主導 | 持有         |
| 空頭弱勢 | RSI 持續 < 50 | 空方主導 | 觀望         |

**RSI 背離訊號**（重要）：

- **看跌背離**：股價創新高，但 RSI 未創新高 → 動能衰竭，減碼訊號
- **看漲背離**：股價創新低，但 RSI 未創新低 → 賣壓減輕，可能反彈

**與乖離率搭配使用**：

- 乖離率 5-10% + RSI 30-50 上升 → **低位階強勢買進**
- 乖離率 > 25% + RSI 背離 → **高位階減碼**

#### 4.4 綜合評分與排序

**最終買賣訊號生成邏輯**：

```
for stock in top_30_fundamental:
    # 1. 檢查籌碼面
    if 法人賣超 or 籌碼發散:
        continue  # 跳過此股票

    # 2. 計算技術面位階
    bias = calculate_bias(stock, period=60)

    # 3. 生成訊號
    if 0 <= bias <= 10%:
        signal = "強力買進（低位階籌碼集中）"
    elif 10% < bias < 20%:
        signal = "加碼持有（動能延續）"
    elif bias >= 20%:
        signal = "減碼（高位階過熱）"
    else:
        signal = "觀望（季線下方）"

    # 4. 輸出結果
    output(stock, signal, bias, 法人買超金額, 大戶持股變化)
```

#### 4.5 進階選項：完整綜合評分模型

本系統預設使用「三層篩選邏輯」（基本面評分 → 籌碼過濾 → 技術位階），適合大多數投資者。若需更精確的量化評分，可參考以下完整評分模型：

**完整評分架構（基於 [FunctionalIndicators.md](FunctionalIndicators.md)）**

```
總分 = 基本面評分 × 40% + 籌碼面評分 × 30% + 技術面評分 × 30%
```

##### 基本面評分細項（40%）

| 指標        | 權重 | 評分標準                                                                 |
| ----------- | ---- | ------------------------------------------------------------------------ |
| ROE         | 10%  | >15%: 5 分, 10-15%: 4 分, 5-10%: 3 分, 0-5%: 2 分, <0%: 1 分             |
| 毛利率趨勢  | 5%   | 連續 3 季上升: 5 分, 上升: 4 分, 持平: 3 分, 下降: 2 分, 連續下降: 1 分  |
| 負債比率    | 5%   | <30%: 5 分, 30-50%: 4 分, 50-60%: 3 分, 60-70%: 2 分, >70%: 1 分         |
| 自由現金流  | 5%   | 連續 3 年正: 5 分, 正: 4 分, 偶爾負: 3 分, 負: 2 分, 連續負: 1 分        |
| 營收 YoY    | 5%   | >20%: 5 分, 10-20%: 4 分, 0-10%: 3 分, -10-0%: 2 分, <-10%: 1 分         |
| EPS YoY     | 5%   | >20%: 5 分, 10-20%: 4 分, 0-10%: 3 分, -20-0%: 2 分, <-20%: 1 分         |
| P/E vs 歷史 | 5%   | <均值-1σ: 5 分, <均值: 4 分, 均值附近: 3 分, >均值: 2 分, >均值+1σ: 1 分 |

##### 籌碼面評分細項（30%）

| 指標             | 權重 | 評分標準                                                                      |
| ---------------- | ---- | ----------------------------------------------------------------------------- |
| 外資連續買超天數 | 8%   | >10 天: 5 分, 5-10 天: 4 分, 1-5 天: 3 分, 賣超 1-5 天: 2 分, 賣超>5 天: 1 分 |
| 投信連續買超天數 | 7%   | 同上                                                                          |
| 外資持股變化(月) | 5%   | 增加>2%: 5 分, 增加: 4 分, 持平: 3 分, 減少: 2 分, 減少>2%: 1 分              |
| 券資比           | 5%   | >30%: 5 分(軋空), 20-30%: 4 分, 10-20%: 3 分, 5-10%: 2 分, <5%: 3 分          |
| 大戶持股變化     | 5%   | 增加>2%: 5 分, 增加: 4 分, 持平: 3 分, 減少: 2 分, 減少>2%: 1 分              |

##### 技術面評分細項（30%）

| 指標         | 權重 | 評分標準                                                                                    |
| ------------ | ---- | ------------------------------------------------------------------------------------------- |
| 股價 vs 均線 | 8%   | >MA5>MA20>MA60 (多頭排列): 5 分, 部分多頭: 4 分, 糾結: 3 分, 部分空頭: 2 分, 空頭排列: 1 分 |
| MACD         | 5%   | DIF>0 且向上: 5 分, DIF>0: 4 分, 零軸附近: 3 分, DIF<0: 2 分, DIF<0 且向下: 1 分            |
| RSI(14)      | 5%   | 40-60 上升: 5 分, 60-70: 4 分, 30-40: 3 分, 70-80: 2 分(超買), <30 或>80: 1 分              |
| KD 交叉      | 5%   | 低檔黃金交叉: 5 分, K>D: 4 分, 糾結: 3 分, K<D: 2 分, 高檔死亡交叉: 1 分                    |
| 量價配合     | 4%   | 價漲量增: 5 分, 價漲量平: 4 分, 盤整縮量: 3 分, 價跌量增: 2 分, 無量下跌: 1 分              |
| 布林帶位置   | 3%   | 中軌上方突破: 5 分, 中軌上方: 4 分, 中軌附近: 3 分, 中軌下方: 2 分, 下軌附近: 1 分          |

**使用時機**：

| 情境         | 建議模型             |
| ------------ | -------------------- |
| 快速每日選股 | 三層篩選邏輯（預設） |
| 深度研究個股 | 完整綜合評分模型     |
| 回測驗證策略 | 完整綜合評分模型     |
| 建立觀察名單 | 三層篩選邏輯         |
| 排序優先順序 | 完整綜合評分模型     |

**評分範例程式碼**：

```python
def comprehensive_score(stock):
    # 基本面評分 (0-200 分)
    fundamental_score = (
        roe_score * 0.10 +
        gross_margin_trend_score * 0.05 +
        debt_ratio_score * 0.05 +
        fcf_score * 0.05 +
        revenue_yoy_score * 0.05 +
        eps_yoy_score * 0.05 +
        pe_historical_score * 0.05
    ) * 100

    # 籌碼面評分 (0-150 分)
    chip_score = (
        foreign_continuous_buy_score * 0.08 +
        trust_continuous_buy_score * 0.07 +
        foreign_holding_change_score * 0.05 +
        short_interest_ratio_score * 0.05 +
        major_holder_change_score * 0.05
    ) * 100

    # 技術面評分 (0-150 分)
    technical_score = (
        ma_alignment_score * 0.08 +
        macd_score * 0.05 +
        rsi_score * 0.05 +
        kd_score * 0.05 +
        volume_price_score * 0.04 +
        bollinger_score * 0.03
    ) * 100

    # 加權總分 (0-500 分)
    total_score = (
        fundamental_score * 0.40 +
        chip_score * 0.30 +
        technical_score * 0.30
    )

    return total_score

# 篩選標準：總分 > 350 分（70 分位數）
```

**完整模型 vs 三層篩選的比較**：

| 比較項目       | 三層篩選邏輯（預設）         | 完整綜合評分模型             |
| -------------- | ---------------------------- | ---------------------------- |
| **計算複雜度** | 低（僅 7 個基本面因子）      | 高（18 個因子）              |
| **執行速度**   | 快（適合每日選股）           | 較慢（適合深度分析）         |
| **數據需求**   | 少（基本財報 + 法人 + 行情） | 多（需融資券、MACD、布林等） |
| **適用場景**   | 快速篩選、建立候選池         | 個股深度評估、排序優先級     |
| **維護成本**   | 低                           | 高（需維護更多數據源）       |
| **準確度**     | 良好（夏普比率 1.2）         | 優秀（夏普比率 1.8）         |

**建議使用策略**：

1. **日常選股**：使用三層篩選邏輯快速建立候選池（30 檔）
2. **深度研究**：對候選池中的股票使用完整評分模型排序
3. **最終決策**：結合完整評分 + 產業趨勢 + 個人風險偏好

---

### 階段五:自動化部署

#### 5.1 每日更新排程

**執行時機**：

- 台股收盤時間：下午 1:30（週一至週五）
- 建議排程時間：下午 3:00（留 1.5 小時緩衝給交易所結算數據）

**排程工具選擇**：

| 工具                   | 適用系統    | 優點               | 缺點           |
| ---------------------- | ----------- | ------------------ | -------------- |
| **cron**               | Linux/macOS | 系統原生、穩定     | Windows 不支援 |
| **Task Scheduler**     | Windows     | 圖形化介面         | 設定較繁瑣     |
| **Python schedule** ⭐ | 跨平台      | 程式碼控制、易除錯 | 需保持腳本運行 |

**使用 Python schedule 範例**：

```python
import schedule
import time

def daily_update():
    """每日數據更新任務"""
    print(f"開始執行每日更新：{datetime.now()}")

    # 1. 更新市值 Top 500 名單
    update_universe()

    # 2. 下載日行情數據
    download_daily_quotes()

    # 3. 下載法人買賣超
    download_institutional_data()

    # 4. 執行選股策略
    run_screening_strategy()

    # 5. 發送通知
    send_notification()

# 設定每天下午 3 點執行
schedule.every().day.at("15:00").do(daily_update)

# 持續運行排程
while True:
    schedule.run_pending()
    time.sleep(60)  # 每分鐘檢查一次
```

**週五額外任務**（集保數據）：

```python
def weekly_tdcc_update():
    """每週五更新集保戶分布數據"""
    download_tdcc_data()

schedule.every().friday.at("18:00").do(weekly_tdcc_update)
```

#### 5.2 策略掃描腳本

**腳本職責**（`scripts/run_strategy.py`）：

1. 讀取最新 Top 500 名單
2. 載入財報數據，計算基本面因子
3. 計算綜合得分，選出 Top 30
4. 載入籌碼數據，進行籌碼檢核
5. 計算技術面位階，生成買賣訊號
6. 輸出 CSV 報表與發送通知

**輸出報表格式**（`reports/selections/selection_{date}.csv`）：

| 欄位                | 說明                    | 範例     |
| ------------------- | ----------------------- | -------- |
| symbol              | 股票代碼                | 2330     |
| name                | 股票名稱                | 台積電   |
| close               | 最新收盤價              | 580      |
| roe                 | 近四季平均 ROE          | 25.3%    |
| eps_yoy             | EPS 年增率              | 12.5%    |
| pe_ratio            | 本益比                  | 18.2     |
| institutional_net   | 近 5 日法人買賣超（張） | +1250    |
| major_holder_change | 大戶持股比例變化        | +2.1%    |
| bias_60             | 季線乖離率              | +8.5%    |
| signal              | 買賣訊號                | 強力買進 |

#### 5.3 訊號通知設定

**Line Notify 整合**：

1. 申請 Line Notify Token：https://notify-bot.line.me/
2. 使用 requests 發送訊息：

```python
import requests

def send_line_notify(message):
    url = "https://notify-api.line.me/api/notify"
    headers = {"Authorization": f"Bearer {LINE_TOKEN}"}
    data = {"message": message}
    requests.post(url, headers=headers, data=data)

# 發送選股結果
message = f"""
📊 每日選股結果（{today}）

🔥 強力買進：
  - 台積電 (2330) | 乖離率 +8.5% | 法人買超 1250 張
  - 聯發科 (2454) | 乖離率 +6.2% | 大戶持股 +2.1%

⚠️ 觀望：
  - XXX (1234) | 籌碼發散

完整報表：reports/selections/selection_{today}.csv
"""
send_line_notify(message)
```

**Telegram Bot 整合**（進階選項）：

- 優點：可設定互動式按鈕、查詢個股資訊
- 需申請 Bot Token 並架設 Webhook

---

## 數據管理

### 市值篩選實作細節

**完整計算流程**：

1. **取得全市場快照**：

```python
# 使用 Shioaji API
snapshots = api.snapshots(api.Contracts.Stocks)
```

2. **計算市值**：

```python
market_caps = []
for snapshot in snapshots:
    market_cap = snapshot.close * snapshot.total_shares  # 收盤價 × 發行股數
    market_caps.append({
        'symbol': snapshot.code,
        'name': snapshot.name,
        'close': snapshot.close,
        'market_cap': market_cap
    })
```

3. **排序與緩衝區邏輯**：

```python
df = pd.DataFrame(market_caps).sort_values('market_cap', ascending=False)
df['rank'] = range(1, len(df) + 1)

# 讀取昨日名單
yesterday_universe = pd.read_parquet(f'universe_top500_{yesterday}.parquet')

# 緩衝區邏輯
new_universe = []
for _, row in df.iterrows():
    if row['rank'] <= 480:
        new_universe.append(row)  # 前 480 直接納入
    elif row['rank'] <= 520:
        if row['symbol'] in yesterday_universe['symbol'].values:
            new_universe.append(row)  # 481-520 若昨日在名單內則保留
    # 排名 > 520 則剔除

# 儲存新名單
pd.DataFrame(new_universe).to_parquet(f'universe_top500_{today}.parquet')
```

### 資料品質控制

**檢查點設計**：

| 檢查項目       | 驗證邏輯                                   | 異常處理                      |
| -------------- | ------------------------------------------ | ----------------------------- |
| **缺失值**     | `df.isnull().sum() > 0`                    | 向前填補（`ffill`）或線性插值 |
| **異常值**     | 股價單日漲跌幅 > 50%                       | 檢查是否為除權息或資料錯誤    |
| **重複值**     | `df.duplicated(subset=['symbol', 'date'])` | 保留最新一筆                  |
| **資料完整性** | 檢查 Top 500 是否都有當日數據              | 記錄缺失股票並通知            |

**自動化驗證腳本**：

```python
def validate_data(df, date):
    errors = []

    # 檢查缺失值
    if df.isnull().sum().sum() > 0:
        errors.append(f"發現缺失值：{df.isnull().sum()}")

    # 檢查異常漲跌幅
    df['change_pct'] = df['close'].pct_change()
    abnormal = df[df['change_pct'].abs() > 0.5]
    if len(abnormal) > 0:
        errors.append(f"異常漲跌幅：{abnormal[['symbol', 'change_pct']]}")

    # 輸出驗證報告
    if errors:
        send_line_notify(f"⚠️ 數據品質警報（{date}）：\n" + "\n".join(errors))
```

---

## 選股策略

### 三層篩選完整流程圖

```
全市場 1700+ 檔股票
         │
         ▼
   ┌─────────────┐
   │ Layer 0:     │
   │ 流動性篩選    │  ──▶ 市值排名 Top 500（排除流動性不足標的）
   └─────────────┘
         │
         ▼
   ┌─────────────┐
   │ Layer 1:     │
   │ 基本面篩選    │  ──▶ Top 30（獲利能力 + 成長性 + 估值）
   └─────────────┘
         │
         ▼
   ┌─────────────┐
   │ Layer 2:     │
   │ 籌碼面驗證    │  ──▶ 過濾籌碼發散標的（法人賣超、散戶大增）
   └─────────────┘
         │
         ▼
   ┌─────────────┐
   │ Layer 3:     │
   │ 技術面位階    │  ──▶ 最終買賣訊號（低位階買進、高位階減碼）
   └─────────────┘
         │
         ▼
   核心持股 15-30 檔
```

### 因子計算範例

**ROE 計算**（近四季平均）：

```python
def calculate_roe(stock_id):
    # 讀取近四季財報
    financials = pd.read_parquet(f'data/fundamentals/quarterly/{stock_id}.parquet')
    recent_4q = financials.tail(4)

    # ROE = 稅後淨利 ÷ 平均股東權益 × 100%
    roe = (recent_4q['net_income'].sum() / recent_4q['equity'].mean()) * 100
    return roe
```

**EPS YoY 計算**：

```python
def calculate_eps_yoy(stock_id):
    financials = pd.read_parquet(f'data/fundamentals/quarterly/{stock_id}.parquet')
    latest_q = financials.iloc[-1]
    same_q_last_year = financials.iloc[-5]  # 去年同季

    eps_yoy = (latest_q['eps'] - same_q_last_year['eps']) / same_q_last_year['eps'] * 100
    return eps_yoy
```

### 回測驗證（選用）

建議定期對策略進行回測驗證：

1. **樣本期間**：至少 3-5 年歷史數據
2. **評估指標**：
   - 年化報酬率（Annualized Return）
   - 夏普比率（Sharpe Ratio）> 1 為佳
   - 最大回撤（Max Drawdown）< 20% 為佳
3. **基準比較**：對比大盤（加權指數）與 0050 ETF

---

## 自動化部署

### 部署方式選擇

| 部署方式                 | 適用場景   | 優點                | 缺點       |
| ------------------------ | ---------- | ------------------- | ---------- |
| **本地電腦** ⭐          | 個人使用   | 免費、完全控制      | 需保持開機 |
| **NAS（Synology/QNAP）** | 家用伺服器 | 24 小時運行、低功耗 | 需購買硬體 |
| **雲端 VM（AWS EC2）**   | 專業用途   | 高可用性            | 需付費     |
| **Docker 容器**          | 跨平台部署 | 環境隔離、易遷移    | 學習曲線   |

**推薦方案**：本地電腦 + Python schedule（入門）→ NAS Docker 部署（進階）

### 錯誤處理機制

**常見錯誤與處理**：

| 錯誤類型             | 可能原因                       | 處理策略                                     |
| -------------------- | ------------------------------ | -------------------------------------------- |
| **API 連線失敗**     | 網路問題、API 維護             | 重試 3 次，間隔 5 秒<br>失敗則發送通知並跳過 |
| **數據缺失**         | 股票停牌、API 限流             | 使用前一日數據填補<br>記錄缺失清單           |
| **Parquet 寫入錯誤** | 磁碟空間不足                   | 檢查可用空間<br>清理暫存檔                   |
| **計算錯誤**         | 財報數據異常（如股東權益為負） | 捕捉異常並跳過該股票<br>記錄於日誌           |

**錯誤通知範例**：

```python
try:
    daily_update()
except Exception as e:
    error_msg = f"❌ 系統錯誤（{datetime.now()}）\n錯誤訊息：{str(e)}"
    send_line_notify(error_msg)
    # 寫入日誌
    logging.error(error_msg, exc_info=True)
```

### 效能監控

**關鍵指標追蹤**：

- 每日更新執行時間（目標 < 5 分鐘）
- 數據完整性（Top 500 覆蓋率 > 98%）
- 選股訊號數量（強力買進標的 5-15 檔為正常）

---

## 附錄

### 名詞解釋

| 術語             | 英文               | 解釋                                           |
| ---------------- | ------------------ | ---------------------------------------------- |
| **無資料庫架構** | No-DB Architecture | 不使用傳統資料庫，直接以檔案系統儲存數據       |
| **列式儲存**     | Columnar Storage   | 同欄位數據連續存放（相對於傳統的「行式儲存」） |
| **謂詞下推**     | Predicate Pushdown | 在讀取檔案時就過濾數據，而非載入全部後再過濾   |
| **Z-Score**      | Z-Score            | 標準化分數，表示數值距離平均值幾個標準差       |
| **籌碼集中**     | Chip Concentration | 股票從散戶流向大戶或法人手中                   |
| **乖離率**       | Bias Ratio         | 股價與移動平均線的偏離程度                     |
| **Smart Beta**   | Smart Beta         | 透過規則化因子取得超額報酬的投資策略           |

### 參考資源

**本專案文件**：

- [FunctionalIndicators.md](FunctionalIndicators.md) - 完整指標計算公式與評分標準（50+ 指標詳細定義）
  - 基本面分析指標：獲利能力、財務體質、成長性、估值、營運效率
  - 籌碼面分析指標：法人動向、融資融券、籌碼集中度、主力進出
  - 技術面分析指標：移動平均線、趨勢、動能、成交量、波動率、支撐壓力

**官方文件**：

- [Shioaji API 文件](https://sinotrade.github.io/)
- [Apache Parquet 官網](https://parquet.apache.org/)
- [Pandas 文件](https://pandas.pydata.org/)

**數據來源**：

- [台灣證券交易所](https://www.twse.com.tw/)
- [公開資訊觀測站](https://mops.twse.com.tw/)
- [集保結算所](https://www.tdcc.com.tw/)

**延伸閱讀**：

- 《Python 量化投資實戰》 - 掌握基本的量化分析技能
- 《Smart Beta 策略》 - 了解因子投資理論
- 《台股籌碼分析》 - 深入理解台股籌碼特性

---

**版本**：v1.0
**最後更新**：2024-01-02
**授權**：MIT License

---

**免責聲明**：本文件僅供教育與研究用途，不構成任何投資建議。投資有風險，請謹慎評估。
